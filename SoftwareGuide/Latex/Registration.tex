
\chapter{Registration}

\piccaption[Image Registration Concept]{Image registration is the task of
finding a spatial transform mapping on image into
another.\label{fig:ImageRegistrationConcept}}
\parpic(8cm,3cm)[r]{\includegraphics[width=8cm]{ImageRegistrationConcept.eps}}
  
This chapter introduces the functionalities offered by Insight for performing
image registration. Image registration is the process in which we determine the
spatial transform that maps points from one image to homologous points on a
object in the second image. This concept is schematically represented in Figure
\ref{fig:ImageRegistrationConcept}. In the toolkit, registration is performed
within a framework of pluggable components that can easily be interchanged.
This flexibility means that a combinatorial variety of registration methods can
be created, allowing the user to pick and choose the right tools for the
application.


\section{Registration Framework}
The components of the registration framework and their interconnections 
are shown in Figure \ref{fig:RegistrationComponents}. The basic
input data to the registration process are two images: one
is defined as the \emph{Fixed} image $f(\bf{X})$ and the other defined as the
\emph{Moving} image $m(\bf{X})$. Registration is treated as an optimization problem
with the goal of finding the spatial mapping that will bring the moving image into 
alignment with the fixed or target image.

\begin{figure}
\center
\includegraphics[width=12cm]{RegistrationComponentsDiagram.eps}
\caption[Registration Framework Components]{The basic components of the
registration framework are two input images, a transform, a metric, an
interpolator and an optimizer.}
\label{fig:RegistrationComponents}
\end{figure}

The \emph{Transform} component $T(\bf{X})$ represents the spatial mapping of
points from the fixed image space to points in the moving image space. Note
that this definition is inverse to the usual view of image transformation.
Using the \emph{inverse} transform is typical in registration as it avoids the
potential problems of ``holes'' with forward transform. The \emph{Interpolator}
is used to evaluate moving image intensity at non-grid positions. The
\emph{Metric} component $S(f,m \circ T)$ provides a measure of how well the
fixed image is matched by the transformed moving image. This measure forms the
quantitative criterion to be optimized by the \emph{Optimizer} over the search
space defined by the parameters of the \emph{Transform}.

The various components available in the toolkit will be described in later sections.
First we begin with some simple registration examples.

\section{Hello World Registration}
\label{sec:IntroductionImageRegistration}
\ifitkFullVersion
\input{ImageRegistration1.tex}
\fi

\section{Monitoring Registration}
\label{sec:MonitoringImageRegistration}
\ifitkFullVersion
\input{ImageRegistration3.tex}
\fi



\section{Multi-Modality Registration}
\label{sec:MultiModalityRegistration}

\subsection{Viola-Wells Mutual Information}
\label{sec:MultiModalityRegistrationViolaWells}
\ifitkFullVersion
\input{ImageRegistration2.tex}
\fi

\subsection{Mattes Mutual Information}
\label{sec:MultiModalityRegistrationMattes}
\ifitkFullVersion
\input{ImageRegistration4.tex}
\fi


\section{ Centered Transforms }

The origin of coordinates in ITK images is usually located in one of image
corners. This results in counter-intuitive behaviors of the transforms when
rotations and scaling are involved. We tend to assume that rotations and
scaling are performed by using a fixed point at the center of the image.  In
order to compensate for this difference in natural interpretation, a set of
\emph{centered} transforms have been introduced in the toolkit. The following
sections describe the main characteristics of such transforms.

\subsection{Rigid Registration in 2D}
\label{sec:RigidRegistrationIn2D}
\ifitkFullVersion
\input{ImageRegistration5.tex}
\fi

\subsection{Initializing with Image Moments}
\label{sec:InitializingRegistrationWithMoments}
\ifitkFullVersion
\input{ImageRegistration6.tex}
\fi


%\subsection{Similarity Transform in 2D}
%\label{sec:SimilarityRegistrationIn2D}
%\ifitkFullVersion
%\input{ImageRegistration7.tex}
%\fi




\section{Multi-Resolution Registration}
\label{sec:MultiResolutionRegistration}
Performing image registration using a multi-resolution approach is widely used
to improve speed, accuracy and robustness. The basic idea is that registration
is first performed at a coarse scale where the images have fewer pixels.
The spatial mapping determined at the coarse level is the used to initialize
registration at the next finer scale. This process is repeated until it
reaches the finest possible scale. This coarse-to-fine strategy greatly
increases the capture range of the registration and also increases robustness
by eliminating local optima at coarser scales.

The Insight toolkit offers a multi-resolution registration framework which
is directly compatible with all the registration framework components. The
multi-resolution registration framework has two additional components:
two \emph{Image Pyramids} which are used to down-sample the fixed and moving
images as illustrated in Figure \ref{fig:MultiResRegistrationComponents}.
The pyramids smooth and subsamples the images according to user defined
schedules of shrink factors. 
 
\begin{figure}
\center
\includegraphics[width=14cm]{MultiResRegistrationComponents.eps}
\caption[Multi-Resolution Registration Components]{Components of the
Multi-Resolution registration framework.}
\label{fig:MultiResRegistrationComponents}
\end{figure}
 
We now present the main capabilities of the multi-resolution framework by
way of an example.

\subsection{Fundamentals}
\ifitkFullVersion
\input{MultiResImageRegistration1.tex}
\fi

\subsection{Parameter Tuning}
\ifitkFullVersion
\input{MultiResImageRegistration2.tex}
\fi

Let's review now the main characteristics of the registration framework components. 

\section{Transforms}
\label{sec:Transforms}
\ifitkFullVersion
\input{Transforms.tex}
\fi

\section{Interpolators}
\label{sec:Interpolators}
\ifitkFullVersion
\input{ImageInterpolators.tex}
\fi

\section{Metrics}
\label{sec:Metrics}
\ifitkFullVersion
\input{ImageMetrics.tex}
\fi

\section{Optimizers}
\label{sec:Optimizers}
\ifitkFullVersion
\input{Optimizers.tex}
\fi

\section{Image Pyramids}
\label{sec:ImagePyramids}
\ifitkFullVersion
\input{ImagePyramids.tex}
\fi


\section{Deformable Registration}
\label{sec:DeformableRegistration}
\ifitkFullVersion
\input{DeformableRegistration.tex}
\fi

\section{Demons Deformable Registration}
\label{sec:DemonsDeformableRegistration}
\ifitkFullVersion
\input{DemonsRegistration.tex}
\fi


\section{Model Based Registration}
\label{sec:ModelBasedRegistration}
\ifitkFullVersion
\input{ModelBasedRegistration.tex}
\fi


